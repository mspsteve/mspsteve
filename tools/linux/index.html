<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>linux命令 | 陌上花开博客</title>
    <meta name="description" content="每天进步一点点">
    
    
    <link rel="preload" href="/assets/css/styles.4720fc85.css" as="style"><link rel="preload" href="/assets/js/app.4720fc85.js" as="script"><link rel="preload" href="/assets/js/57.eb061203.js" as="script"><link rel="prefetch" href="/assets/js/20.1f81db7c.js"><link rel="prefetch" href="/assets/css/1.styles.5fc62c76.css"><link rel="prefetch" href="/assets/js/1.5fc62c76.js"><link rel="prefetch" href="/assets/css/2.styles.bc490884.css"><link rel="prefetch" href="/assets/js/2.bc490884.js"><link rel="prefetch" href="/assets/js/3.e2cedc59.js"><link rel="prefetch" href="/assets/js/4.c645c891.js"><link rel="prefetch" href="/assets/js/5.03266063.js"><link rel="prefetch" href="/assets/js/6.674566fd.js"><link rel="prefetch" href="/assets/js/7.bcea4b1b.js"><link rel="prefetch" href="/assets/js/8.34dec1f9.js"><link rel="prefetch" href="/assets/js/9.ee0b5a00.js"><link rel="prefetch" href="/assets/js/10.1a04f867.js"><link rel="prefetch" href="/assets/js/11.fd2d1907.js"><link rel="prefetch" href="/assets/js/12.ea6a496e.js"><link rel="prefetch" href="/assets/js/13.52d42115.js"><link rel="prefetch" href="/assets/js/14.631d0550.js"><link rel="prefetch" href="/assets/js/15.22fecd09.js"><link rel="prefetch" href="/assets/js/16.4acddf9c.js"><link rel="prefetch" href="/assets/js/17.b287c2b8.js"><link rel="prefetch" href="/assets/js/18.16fb90c4.js"><link rel="prefetch" href="/assets/js/19.6f8fe613.js"><link rel="prefetch" href="/assets/js/21.3cfbcd4b.js"><link rel="prefetch" href="/assets/js/22.638cab3a.js"><link rel="prefetch" href="/assets/js/23.ad82ee65.js"><link rel="prefetch" href="/assets/js/24.59b155e3.js"><link rel="prefetch" href="/assets/js/25.3b58bd6c.js"><link rel="prefetch" href="/assets/js/26.04269eb0.js"><link rel="prefetch" href="/assets/js/27.7d8f9cdd.js"><link rel="prefetch" href="/assets/js/28.481a177a.js"><link rel="prefetch" href="/assets/js/29.cafe6a2a.js"><link rel="prefetch" href="/assets/js/30.af49ec21.js"><link rel="prefetch" href="/assets/js/31.bdc1b88d.js"><link rel="prefetch" href="/assets/js/32.10e36c02.js"><link rel="prefetch" href="/assets/js/33.3be50ad2.js"><link rel="prefetch" href="/assets/js/34.7da30499.js"><link rel="prefetch" href="/assets/js/35.dca94238.js"><link rel="prefetch" href="/assets/js/36.0fcaa35c.js"><link rel="prefetch" href="/assets/js/37.0dfa6d70.js"><link rel="prefetch" href="/assets/js/38.79135398.js"><link rel="prefetch" href="/assets/js/39.45bb2efc.js"><link rel="prefetch" href="/assets/js/40.1ea6797b.js"><link rel="prefetch" href="/assets/js/41.67e0af51.js"><link rel="prefetch" href="/assets/js/42.75eeffda.js"><link rel="prefetch" href="/assets/js/43.1e1aadc2.js"><link rel="prefetch" href="/assets/js/44.ad2c4711.js"><link rel="prefetch" href="/assets/js/45.a95621f9.js"><link rel="prefetch" href="/assets/js/46.cd596d91.js"><link rel="prefetch" href="/assets/js/47.b1385fd9.js"><link rel="prefetch" href="/assets/js/48.fa0a2448.js"><link rel="prefetch" href="/assets/js/49.19b0e6f6.js"><link rel="prefetch" href="/assets/js/50.565e6599.js"><link rel="prefetch" href="/assets/js/51.e20b2bad.js"><link rel="prefetch" href="/assets/js/52.c921f9fe.js"><link rel="prefetch" href="/assets/js/53.880edf56.js"><link rel="prefetch" href="/assets/js/54.89bae591.js"><link rel="prefetch" href="/assets/js/55.7fb4aeb6.js"><link rel="prefetch" href="/assets/js/56.283a312a.js"><link rel="prefetch" href="/assets/js/58.8804a74c.js">
    <link rel="stylesheet" href="/assets/css/styles.4720fc85.css"><link rel="stylesheet" href="/assets/css/1.styles.5fc62c76.css"><link rel="stylesheet" href="/assets/css/2.styles.bc490884.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">陌上花开博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">java</a></li><li class="dropdown-item"><!----> <a href="/jvm/theory/" class="nav-link">原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/rpc/" class="nav-link">rpc</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/message/" class="nav-link">message</a></li><li class="dropdown-item"><!----> <a href="/nginx/" class="nav-link">nginx</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">AI</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/reco/" class="nav-link">集体智慧编程</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link router-link-active">命令</a></li><li class="dropdown-item"><!----> <a href="/date/" class="nav-link">日常</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/" class="nav-link">面试</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/mspsteve/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">java</a></li><li class="dropdown-item"><!----> <a href="/jvm/theory/" class="nav-link">原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/rpc/" class="nav-link">rpc</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/message/" class="nav-link">message</a></li><li class="dropdown-item"><!----> <a href="/nginx/" class="nav-link">nginx</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">AI</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/reco/" class="nav-link">集体智慧编程</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">日常积累</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link router-link-active">命令</a></li><li class="dropdown-item"><!----> <a href="/date/" class="nav-link">日常</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">other</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">面试</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/" class="nav-link">面试</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/mspsteve/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>常用命令</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/tools/" class="sidebar-link">目录</a></li><li><a href="/tools/hadoop/" class="sidebar-link">hadoop命令</a></li><li><a href="/tools/hive/" class="sidebar-link">hive命令</a></li><li><a href="/tools/linux/" class="active sidebar-link">linux命令</a></li><li><a href="/tools/ant/" class="sidebar-link">ant命令</a></li><li><a href="/tools/markdown/" class="sidebar-link">linux命令</a></li><li><a href="/tools/java/" class="sidebar-link">JVM常用命令整理</a></li><li><a href="/tools/charles/" class="sidebar-link">charles</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="linux命令"><a href="#linux命令" aria-hidden="true" class="header-anchor">#</a> linux命令</h1> <p></p><div class="table-of-contents"><ul><li><a href="#常用基础命令">常用基础命令</a><ul><li><a href="#crontab命令">crontab命令</a></li><li><a href="#crond用法">crond用法</a></li><li><a href="#awk命令">awk命令</a></li><li><a href="#cut命令">cut命令</a></li></ul></li><li><a href="#负载问题排查">负载问题排查</a><ul><li><a href="#基本概念">基本概念</a></li><li><a href="#排查问题思路">排查问题思路</a></li></ul></li><li><a href="#内存问题排查">内存问题排查</a><ul><li><a href="#基本概念">基本概念</a></li><li><a href="#free命令-与-top命令-参照上面">free命令 与 top命令(参照上面)</a></li><li><a href="#buffer与cache区别">buffer与cache区别</a></li><li><a href="#cachestat与cachestop命令率查询利器">cachestat与cachestop命令率查询利器</a></li></ul></li><li><a href="#文件系统">文件系统</a><ul><li><a href="#磁盘性能指标">磁盘性能指标</a></li><li><a href="#磁盘排查工具">磁盘排查工具</a></li></ul></li></ul></div><p></p> <h2 id="常用基础命令"><a href="#常用基础命令" aria-hidden="true" class="header-anchor">#</a> 常用基础命令</h2> <h3 id="crontab命令"><a href="#crontab命令" aria-hidden="true" class="header-anchor">#</a> crontab命令</h3> <ul><li>crond linux循环运行的定时任务</li> <li>at命令为一次运行任务</li> <li>文件路径：/etc/crontab</li> <li>crond表达式格式:minute   hour   day   month   week   command</li> <li>crond日志重定向 ：0 */3 * * * /usr/local/apache2/apachectl restart &gt;/dev/null 2&gt;&amp;1</li> <li>crond用法</li></ul> <h3 id="crond用法"><a href="#crond用法" aria-hidden="true" class="header-anchor">#</a> crond用法</h3> <ul><li>crond服务</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>service crond status <span class="token comment">#查看crontab服务状态</span>
service crond <span class="token function">start</span>  <span class="token comment">#手动启动crontab服务</span>
ntsysv <span class="token comment">#查看crontab服务是否已设置为开机启动，执行命令</span>
chkconfig –level 35 crond on <span class="token comment">#加入开机自动启动</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>crontab命令</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>crontab <span class="token operator">-</span>l <span class="token comment">#列出crontab文件</span>
crontab <span class="token operator">-</span>e <span class="token comment">#编辑crontab文件，保存后自动运行</span>
crontab <span class="token operator">-</span>r <span class="token comment">#删除crontab文件</span>
crontab &lt;filename&gt; <span class="token comment">#恢复丢失文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="awk命令"><a href="#awk命令" aria-hidden="true" class="header-anchor">#</a> awk命令</h3> <h3 id="cut命令"><a href="#cut命令" aria-hidden="true" class="header-anchor">#</a> cut命令</h3> <h2 id="负载问题排查"><a href="#负载问题排查" aria-hidden="true" class="header-anchor">#</a> 负载问题排查</h2> <h3 id="基本概念"><a href="#基本概念" aria-hidden="true" class="header-anchor">#</a> 基本概念</h3> <p><strong>平均负载</strong>：在单位时间内，系统处于可执行状态和不可中断状态的平均进程数，也就是平均活跃进程数,实质上是指活跃进程数的指数衰减平均值。<br></p> <p><strong>可运行状态</strong>：是指正在使用CPU或者正在等待CPU的进程，也就是我们用ps命令时看到的，处于R状态的进程。<br></p> <p><strong>不可中断状态</strong>：是处于内核态关键流程中的进程，并且这些流程是不可以打断的，比如说常见的是等待硬件设备的I/O响应，也就是我们再ps命令中看到的D状态(<code>Uninterruptible Sleep</code>，也称为<code>Disk Sleep</code>)<br></p> <p><strong>平均活跃线程数</strong>：综合上面表述，平均活跃线程数正在使用CPU的进程，还包括等待CPU和等待I/O的进程。</p> <p><strong>CPU使用率</strong>：单位时间内CPU繁忙情况的统计，跟平均负载并不一定完全对应。CPU密集型进程，使用大量CPU会导致平均负载升高，此时能够通过平均负载体现;I/O密集型进程，等待I/O也会导致平均负载升高，此时CPU使用率不一定高。
大量等待CPU的进程调度也会导致平均负载升高，CPU使用率也比较高。</p> <p><strong>CPU上下文切换</strong>：将上一个任务的CPU寄存器和程序计数器的内容保存起来，然后将新任务的上下文的内容加载到CPU寄存器和程序计数器，然后跳转到程序计数器所指的新位置，运行新任务。系统调用过程中，会发生两次CPU上下文切换。</p> <h3 id="排查问题思路"><a href="#排查问题思路" aria-hidden="true" class="header-anchor">#</a> 排查问题思路</h3> <ul><li>使用uptime 或者top判断系统是否过载</li></ul> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>$ uptime
 15:39:25 up 197 days, 38 min, 11 users,  load average: 2.70, 3.34, 3.18
# 当前时间    运行天数           正在登陆用户数              1分钟  5分钟 15分钟负载
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>通过过去15分钟 -&gt; 5分钟 -&gt; 1分钟 负载的变化，说明系统负载在降低,
实际生产环境，当平均负载高于CPU数据70%，需要分析负载过高的原因</p></div> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>top - 14:20:05 up 211 days, 23:18,  3 users,  load average: 5.30, 3.72, 3.65
Tasks: 639 total,   2 running, 635 sleeping,   0 stopped,   2 zombie
%Cpu(s):  5.9 us,  0.6 sy,  0.0 ni, 93.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem : 13161476+total,  6327752 free, 10753504+used, 17751960 buff/cache
KiB Swap:        0 total,        0 free,        0 used. 18833468 avail Mem

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
  8604 web_ser+  20   0  216284  28024   7756 R 101.0  0.0  14447:05 test_blob_serve
 56286 web_ser+  20   0 14.692g 4.824g   9064 S  66.1  3.8  12546:35 test_share_embe
 16055 web_ser+  20   0 4164276 2.027g   2868 S  54.2  1.6  36809:02 test_red_packet
 46902 web_ser+  20   0 20.002t 1.632g  14380 S  53.2  1.3   8998:13 test_share_retr
 11085 web_ser+  20   0 25.572g 1.090g  44872 S  32.2  0.9   1717:05 java
 72043 web_ser+  20   0 3253632 1.340g   9796 S  16.6  1.1   3024:33 test_share_caes
 78793 web_ser+  20   0 23.493g 1.674g  41512 S  11.3  1.3 219:24.07 java
 54142 web_ser+  20   0 5899060 299172  11428 S   2.0  0.2 450:33.41 test_share_serv
 58886 web_ser+  20   0 17.405g 1.966g  45620 S   1.7  1.6  83:40.31 java
 82489 web_ser+  20   0 35.817g 4.380g  13980 S   1.3  3.5 629:33.95 java
 82501 web_ser+  20   0 22.157g 2.746g  13868 S   1.3  2.2 716:36.05 java
117446 web_ser+  20   0 24.173g 1.749g  13852 S   1.3  1.4 716:24.98 java
133546 web_ser+  20   0 62.963g 4.594g  13836 S   1.3  3.7 887:04.45 java
135612 web_ser+  20   0 14.129g 1.891g  14664 S   1.3  1.5  58:31.51 java
143794 web_ser+  22   2 30.366g 5.138g  14372 S   1.3  4.1 680:40.74 java
176853 web_ser+  20   0 8920400 2.042g  14428 S   1.3  1.6   3:02.78 java
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>第一行分别为：当前系统时间，已运行时间，用户，负载(5分钟、10分钟、15分钟)<br>
第二行分别为：任务运行时间<br>
第三行为任务的状态<br>
第四行为CPU状态：</p> <ul><li><p>us, user： 运行(未调整优先级的) 用户进程的CPU时间</p></li> <li><p>sy，system: 运行内核进程的CPU时间</p></li> <li><p>ni，niced：运行已调整优先级的用户进程的CPU时间</p></li> <li><p>wa，IO wait: 用于等待IO完成的CPU时间</p></li> <li><p>hi：处理硬件中断的CPU时间</p></li> <li><p>si: 处理软件中断的CPU时间</p></li> <li><p>st：这个虚拟机被hypervisor偷去的CPU时间（译注：如果当前处于一个hypervisor下的vm，实际上hypervisor也是要消耗一部分CPU处理时间的）。
第五行为物理内存使用情况
第六行为虚拟内存使用情况
第七行为各个进程的状态监控</p></li> <li><p>PID：进程ID，进程的唯一标识符</p></li> <li><p>USER：进程所有者的实际用户名。</p></li> <li><p>PR：进程的调度优先级。这个字段的一些值是'rt'。这意味这这些进程运行在实时态。</p></li> <li><p>NI：进程的nice值（优先级）。越小的值意味着越高的优先级。负值表示高优先级，正值表示低优先级</p></li> <li><p>VIRT：进程使用的虚拟内存。进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</p></li> <li><p>RES：驻留内存大小。驻留内存是任务使用的非交换物理内存大小。进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</p></li> <li><p>SHR：SHR是进程使用的共享内存。共享内存大小，单位kb</p></li> <li><p>S：这个是进程的状态。它有以下不同的值:</p> <ul><li>D - 不可中断的睡眠态。</li> <li>R – 运行态</li> <li>S – 睡眠态</li> <li>T – 被跟踪或已停止</li> <li>Z – 僵尸态</li></ul></li> <li><p>%CPU：自从上一次更新时到现在任务所使用的CPU时间百分比。</p></li> <li><p>%MEM：进程使用的可用物理内存百分比。</p></li> <li><p>TIME+：任务启动后到现在所使用的全部CPU时间，精确到百分之一秒。</p></li> <li><p>COMMAND：运行进程所使用的命令。进程名称（命令名/命令行）</p></li></ul></div> <ul><li>判断linux 系统cpu个数</li></ul> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>$ grep 'model name' /proc/cpuinfo | wc -l
56
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>使用mpstat 查询CPU使用率情况，判断是否为CPU密集型还是I/O密集型,或者是线程数据过多</li></ul> <div class="language-linux line-numbers-mode"><pre class="language-text"><code># -P ALL 表示监控所有 CPU，后面数字5表示间隔5s后输出一组数据
$ mpstat -P ALL 5
Linux 3.10.0-693.5.2.el7.x86_64 (bjfk-rs7369.yz02) 	2019年02月21日 	_x86_64_	(56 CPU)

15时47分11秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
15时47分15秒  all    5.12    0.02    0.68    0.02    0.00    0.01    0.00    0.00    0.00   94.15
15时47分15秒    0    3.98    0.00    1.33    0.00    0.00    0.00    0.00    0.00    0.00   94.69
15时47分15秒    1   30.71    0.00    0.52    0.00    0.00    0.00    0.00    0.00    0.00   68.77
15时47分15秒    2    4.18    0.26    1.04    0.00    0.00    0.00    0.00    0.00    0.00   94.52
15时47分15秒    3    0.52    0.00    0.26    0.00    0.00    0.00    0.00    0.00    0.00   99.21
15时47分15秒    4    6.07    0.00    1.06    0.26    0.00    0.00    0.00    0.00    0.00   92.61
15时47分15秒    5    0.52    0.00    0.26    0.00    0.00    0.00    0.00    0.00    0.00   99.21
15时47分15秒    6    4.44    0.00    1.04    0.00    0.00    0.00    0.00    0.00    0.00   94.52
15时47分15秒    7    0.26    0.00    0.26    0.00    0.00    0.00    0.00    0.00    0.00   99.48
15时47分15秒    8    2.62    0.00    0.52    0.26    0.00    0.00    0.00    0.00    0.00   96.60
15时47分15秒    9    0.52    0.00    0.26    0.00    0.00    0.00    0.00    0.00    0.00   99.21
15时47分15秒   10    2.88    0.26    0.52    0.00    0.00    0.00    0.00    0.00    0.00   96.34
……
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li>03:29:29 PM : 指mpstat运行的时间</li> <li>all : 指所有CPU</li> <li>%usr : 显示在用户级别（例如应用程序）执行时CPU利用率的百分比</li> <li>%nice :显示在拥有nice优先级的用户级别执行时CPU利用率的百分比</li> <li>%sys : 现实在系统级别（例如内核）执行时CPU利用率的百分比</li> <li>%iowait : 显示在系统有未完成的磁盘I/O请求期间CPU空闲时间的百分比</li> <li>%irq : 显示CPU服务硬件中断所花费时间的百分比</li> <li>%soft : 显示CPU服务软件中断所花费时间的百分比</li> <li>%steal : 显示虚拟机管理器在服务另一个虚拟处理器时虚拟CPU处在非自愿等待下花费时间的百分比</li> <li>%guest : 显示运行虚拟处理器时CPU花费时间的百分比</li> <li>%idle : 显示CPU空闲和系统没有未完成的磁盘I/O请求情况下的时间百分比</li></ul></div> <ul><li>I/O密集型或者线程数量过多，使用pidstat查询iowait，确认进程(针对I/O过多或者进程争抢过大的情况无法判断)</li></ul> <div class="language-linux line-numbers-mode"><pre class="language-text"><code># 间隔 5 秒后输出一组数据，-u 表示 CPU 指标
$ pidstat -u 5 1
Linux 4.15.0 (ubuntu)     09/22/18     _x86_64_    (2 CPU)
13:42:08      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
13:42:13        0       104    0.00    3.39    0.00    0.00    3.39     1  kworker/1:1H
13:42:13        0       109    0.00    0.40    0.00    0.00    0.40     0  kworker/0:1H
13:42:13        0      2997    2.00   35.53    0.00    3.99   37.52     1  stress
13:42:13        0      3057    0.00    0.40    0.00    0.00    0.40     0  pidstat

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>使用vmstat分析切换以及切换类型来判断I/O过多或者线程争抢过大</li></ul> <div class="language-linux line-numbers-mode"><pre class="language-text"><code>vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 4  0      0 2783080 374944 13835420    0    0     3    54    0    0  7  1 92  0  0
 3  0      0 2783412 374944 13835420    0    0     0    96 92709 50615  6  1 93  0  0
 2  0      0 2784440 374944 13835520    0    0     0     0 52740 52105  5  1 95  0  0
 4  0      0 2785980 374944 13835484    0    0     0     0 53759 48080  5  1 95  0  0
 3  0      0 2784212 374944 13835996    0    0     0    16 59296 51606  5  0 94  0  0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li><strong>r</strong> 表示运行队列(就是说多少个进程真的分配到CPU)</li> <li><strong>b</strong> 表示阻塞的进程</li> <li>swpd 虚拟内存已使用的大小</li> <li>free 空闲物理内存</li> <li>buff Linux/Unix系统是用来存储缓存</li> <li>cache 缓存文件</li> <li>si  每秒从磁盘读入虚拟内存的大小</li> <li>so  每秒虚拟内存写入磁盘的大小</li> <li>bi  块设备每秒接收的块数量,默认大小1024byte</li> <li>bo  块设备每秒发送的块数量</li> <li><strong>in</strong>  每秒CPU的中断次数，包括时间中断</li> <li><strong>cs</strong>  每秒上下文切换次数</li> <li>us  用户CPU时间</li> <li>sy  系统CPU时间</li> <li>id  空闲CPU时间，一般来说，id + us + sy = 100</li></ul></div> <p>重点分析标记4列，判断是否为CPU频繁的上下文切换导致。</p> <ul><li><p>lsof（list open files）是一个查看当前系统文件的工具，也可以用于问题排查，具体见<a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/lsof.html" target="_blank" rel="noopener noreferrer">博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>top、uptime等命令只能查询出来长时间进程，短时间进程可使用perf命令查询，可以统计某个时间段内数据，使用pstree可以查询子进程</p></li></ul> <div class="language-linux line-numbers-mode"><pre class="language-text"><code># 记录性能事件，等待大约 15 秒后按 Ctrl+C 退出
$ perf record -g

# 查看报告
$ perf report

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>僵尸进程如何排查</li></ul> <p>既然僵尸进程是因为父进程没有回收子进程的资源而出现的，要解决子进程的僵尸问题，需要在父进程中解决。使用pstree查看父进程，然后具体分析。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># -a 表示输出命令行选项
# p 表 PID
# s 表示指定进程的父进程
$ pstree -aps 3084
systemd,1
  └─dockerd,15006 -H fd://
      └─docker-containe,15024 --config /var/run/docker/containerd/containerd.toml
          └─docker-containe,3991 -namespace moby -workdir...
              └─app,4009
                  └─(app,3084)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>大量不可中断的进程如何解决</li></ul> <p>不可中断状态：一般表示进程正在跟硬件交互，为了保护进程数据与硬件一致，系统不允许其他进程或中断打断该进程。<br>
使用top或者ps查看系统有多少不可中断进程，top命令中S列为D的进程，需要查看iowait是否变大。</p> <p>使用dstat，观察CPU以及IO的使用情况(主要关注D状态进程)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 间隔 1 秒输出 10 组数据
$ dstat 1 10
You did not select any stats, using -cdngy by default.
--total-cpu-usage-- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai stl| read  writ| recv  send|  in   out | int   csw
  0   0  96   4   0|1219k  408k|   0     0 |   0     0 |  42   885
  0   0   2  98   0|  34M    0 | 198B  790B|   0     0 |  42   138
  0   0   0 100   0|  34M    0 |  66B  342B|   0     0 |  42   135
  0   0  84  16   0|5633k    0 |  66B  342B|   0     0 |  52   177
  0   3  39  58   0|  22M    0 |  66B  342B|   0     0 |  43   144
  0   0   0 100   0|  34M    0 | 200B  450B|   0     0 |  46   147
  0   0   2  98   0|  34M    0 |  66B  342B|   0     0 |  45   134
  0   0   0 100   0|  34M    0 |  66B  342B|   0     0 |  39   131
  0   0  83  17   0|5633k    0 |  66B  342B|   0     0 |  46   168
  0   3  39  59   0|  22M    0 |  66B  342B|   0     0 |  37   134
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>使用pidstat命令，用-p 进程号来查看进程读写情况</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ pidstat -d -p 123656 1 3
Linux 3.10.0-693.5.2.el7.x86_64 (bjfk-rs7369.yz02) 	2019年03月08日 	_x86_64_	(56 CPU)

17时32分21秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
17时32分22秒  1101    123656      0.00      0.00      0.00  java
17时32分23秒  1101    123656      0.00      0.00      0.00  java
17时32分24秒  1101    123656      0.00      0.00      0.00  java
平均时间:  1101    123656      0.00      0.00      0.00  java
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>借助动态工具，比如说perf命令来进一步确认</p> <ul><li><p>软中断以及软中断带来的CPU性能优化问题
中断是一种异步的事件处理机制，用来提升系统的并发处理能力。中断事件发生会触发执行中断处理程序，中断处理程序主要分为上半部和下半部这两个部分：</p> <ul><li>上半部对应硬中断，用来快速处理中断</li> <li>下半部对应软中断，用来异步处理上半部未完成的工作</li></ul> <p>linux软中断包括网络收发、定时、RCU锁等各种类型，可以查看proc/softirqs观察软中断运行情况。linux系统中软中断对应软中断内核线程，软中断事件的频率过高时，
内核线程也会因为CPU使用使用率过高而导致软中断处理不及时，从而进一步导致网络收发延迟、调度缓慢等性能问题。</p></li></ul> <p>sar 是一个系统活动报告工具，既可以实时查看系统的当前活动，又可以配置保存和报告历史统计数据，可以从多方面对系统的活动进行报告，包括：文件的读写情况、系统调用的使用情况、磁盘I/O、CPU效率、内存使用状况、进程活动及IPC有关的活动等。<br></p> <p>hping3 是一个可以构造 TCP/IP 协议数据包的工具，可以对系统进行安全审计、防火墙测试等。<br>
tcpdump 是一个常用的网络抓包工具，常用来分析各种网络问题。<br></p> <h2 id="内存问题排查"><a href="#内存问题排查" aria-hidden="true" class="header-anchor">#</a> 内存问题排查</h2> <h3 id="基本概念-2"><a href="#基本概念-2" aria-hidden="true" class="header-anchor">#</a> 基本概念</h3> <p><strong>linux内存分配</strong>:linux内核给每个进程都提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样，进程就可以很方便地访问内存，更确切地说是访问虚拟内存。虚拟地址空间的内部又被分为内核空间和用户空间两部分。<br> <strong>内核态和用户态</strong>：进程在用户态时，只能访问用户空间内存；只有进入内核态后，才可以访问内核空间内存。虽然每个进程的地址空间都包含了内核空间，但这些内核空间，其实关联的都是相同的物理内存。当进程切换到内核态后，就可以很方便地访问内核空间内存。<br></p> <h3 id="free命令-与-top命令-参照上面"><a href="#free命令-与-top命令-参照上面" aria-hidden="true" class="header-anchor">#</a> free命令 与 top命令(参照上面)</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code># 注意不同版本的 free 输出可能会有所不同
$ free
              total        used        free      shared  buff/cache   available
Mem:        8169348      263524     6875352         668     1030472     7611064
Swap:             0           0           0

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li>其中两行分别为物理内存Mem和交换分区Swap的使用情况</li> <li>第一列表示总内存大小，第二列为已使用内存，第三列为未使用内存大小，第四列为共享内存大小，第五轮为缓存和缓冲区的大小，最后一列为新进程可用内存的大小。</li></ul></div> <h3 id="buffer与cache区别"><a href="#buffer与cache区别" aria-hidden="true" class="header-anchor">#</a> buffer与cache区别</h3> <ul><li>buffer是对原始磁盘块的临时存储，用于缓存磁盘数据，可以将写操作几种起来批量操作，统一优化磁盘的写入。</li> <li>Cache是从磁盘读取文件的页缓存，用于缓存从文件读取的数据，下次读取数据时，可以直接从内存中快速读取。</li> <li>读写磁盘或者分区时，跳过文件系统，使用的buffer缓存；读写普通文件时，会经过文件系统，由文件系统负责与磁盘交互，使用的是cache。</li></ul> <h3 id="cachestat与cachestop命令率查询利器"><a href="#cachestat与cachestop命令率查询利器" aria-hidden="true" class="header-anchor">#</a> cachestat与cachestop命令率查询利器</h3> <ul><li>cachestat 提供了整个操作系统缓存的读写命中情况。</li> <li>cachetop 提供了每个进程的缓存命中情况。</li> <li>使用说明</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ cachestat 1 3
   TOTAL   MISSES     HITS  DIRTIES   BUFFERS_MB  CACHED_MB
       2        0        2        1           17        279
       2        0        2        1           17        279
       2        0        2        1           17        279
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li>TOTAL ，表示总的 I/O 次数；</li> <li>MISSES ，表示缓存未命中的次数；</li> <li>HITS ，表示缓存命中的次数；</li> <li>DIRTIES， 表示新增到缓存中的脏页数；</li> <li>BUFFERS_MB 表示 Buffers 的大小，以 MB 为单位；</li> <li>CACHED_MB 表示 Cache 的大小，以 MB 为单位。</li></ul></div> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ cachetop
11:58:50 Buffers MB: 258 / Cached MB: 347 / Sort: HITS / Order: ascending
PID      UID      CMD              HITS     MISSES   DIRTIES  READ_HIT%  WRITE_HIT%
13029   root     python                  1        0        0     100.0%       0.0%

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>READ_HIT和WRITE_HIT，分别表示读和写的缓存命中率。</p></div> <h2 id="文件系统"><a href="#文件系统" aria-hidden="true" class="header-anchor">#</a> 文件系统</h2> <h3 id="磁盘性能指标"><a href="#磁盘性能指标" aria-hidden="true" class="header-anchor">#</a> 磁盘性能指标</h3> <ul><li>使用率</li> <li>饱和度</li> <li>IOPS</li> <li>吞吐量</li> <li>响应时间</li></ul> <h3 id="磁盘排查工具"><a href="#磁盘排查工具" aria-hidden="true" class="header-anchor">#</a> 磁盘排查工具</h3> <ul><li><p>df查询磁盘使用情况(镜像)</p></li> <li><p>磁盘I/O使用情况(实时)</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code># -d -x 表示显示所有磁盘 I/O 的指标
$ iostat -d -x 1
Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00
loop1            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00
sda              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00
sdb              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>进程I/O观测</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ pidstat -d 1
13:39:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
13:39:52      102       916      0.00      4.00      0.00       0  rsyslogd

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>进程I/O观测</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ iotop
Total DISK READ :       0.00 B/s | Total DISK WRITE :       7.85 K/s
Actual DISK READ:       0.00 B/s | Actual DISK WRITE:       0.00 B/s
  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND
15055 be/3 root        0.00 B/s    7.85 K/s  0.00 %  0.00 % systemd-journald

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>线程IO频繁操作问题排查：iostat(排查磁盘情况) -&gt; strace(追踪线程) -&gt;lsof(找到线程操作文件)</li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/11/2019, 11:40:10 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/tools/hive/" class="prev">
          hive命令
        </a></span> <span class="next"><a href="/tools/ant/">
          ant命令
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/57.eb061203.js" defer></script><script src="/assets/js/app.4720fc85.js" defer></script>
  </body>
</html>
